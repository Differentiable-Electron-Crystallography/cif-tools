<!DOCTYPE html>
<!--
  IMPORTANT: Before opening this demo, build the web WASM package:
    wasm-pack build --target web --out-dir pkg

  Then serve this file with an HTTP server (required for WASM loading):
    python -m http.server 8000
  And open: http://localhost:8000/wasm-demo.html
-->
<html>
<head>
    <meta charset="utf-8">
    <title>CIF Parser WASM Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .output {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        
        button:hover {
            background-color: #005a99;
        }
        
        .error {
            color: red;
        }
        
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>CIF Parser WebAssembly Demo</h1>
    <p>This demo shows the CIF parser compiled to WebAssembly running in the browser.</p>
    
    <button onclick="loadExample()">Load Example CIF</button>
    <button onclick="parseCif()">Parse CIF</button>
    <button onclick="clearOutput()">Clear Output</button>
    
    <div class="container">
        <div>
            <h3>CIF Input</h3>
            <textarea id="cifInput" placeholder="Paste your CIF content here...">data_example
_cell_length_a 10.000
_cell_length_b 20.000
_cell_length_c 30.000
_cell_angle_alpha 90.0
_cell_angle_beta 90.0
_cell_angle_gamma 90.0
_author_name 'John Doe'
_title 'Example Crystal Structure'

loop_
_atom_site_label
_atom_site_type_symbol
_atom_site_fract_x
_atom_site_fract_y
_atom_site_fract_z
C1 C 0.1234 0.5678 0.9012
N1 N 0.2345 0.6789 0.0123
O1 O 0.3456 0.7890 0.1234
C2 C 0.4567 0.8901 0.2345

save_frame1
_frame_item1 'Frame data 1'
_frame_item2 42.0

loop_
_frame_loop_tag1
_frame_loop_tag2
val1 val2
val3 val4
save_</textarea>
        </div>
        
        <div>
            <h3>Parsed Output</h3>
            <div id="output" class="output">Click "Parse CIF" to see the parsed structure...</div>
        </div>
    </div>

    <script type="module">
        import init, { JsCifDocument, test_wasm, get_version } from './pkg/cif_parser.js';
        
        let wasmInitialized = false;
        
        async function initWasm() {
            if (!wasmInitialized) {
                await init();
                wasmInitialized = true;
                console.log('WASM module initialized');
                console.log('Version:', get_version());
                console.log('Test:', test_wasm());
            }
        }
        
        window.loadExample = function() {
            // Already loaded in the textarea
            document.getElementById('output').innerHTML = 'Example CIF loaded. Click "Parse CIF" to parse it.';
        }
        
        window.parseCif = async function() {
            await initWasm();
            
            const input = document.getElementById('cifInput').value;
            const output = document.getElementById('output');
            
            if (!input.trim()) {
                output.innerHTML = '<span class="error">Please enter some CIF content to parse.</span>';
                return;
            }
            
            try {
                output.innerHTML = '<span class="success">Parsing CIF content...</span>';
                
                const doc = JsCifDocument.parse(input);
                let result = `<span class="success">✅ Successfully parsed CIF!</span>

<strong>Document Summary:</strong>
- Number of blocks: ${doc.get_block_count()}
- Block names: ${doc.get_block_names().join(', ')}

`;

                // Process each block
                for (let i = 0; i < doc.get_block_count(); i++) {
                    const block = doc.get_block(i);
                    result += `
<strong>Block ${i}: "${block.name}"</strong>
- Items: ${block.get_item_keys().length}
- Loops: ${block.get_loop_count()}
- Frames: ${block.get_frame_count()}

<strong>Data Items:</strong>
`;
                    
                    const itemKeys = block.get_item_keys();
                    for (const key of itemKeys) {
                        const value = block.get_item(key);
                        if (value) {
                            let valueStr = '';
                            if (value.is_text()) {
                                valueStr = `"${value.text_value}"`;
                            } else if (value.is_numeric()) {
                                valueStr = value.numeric_value.toString();
                            } else if (value.is_unknown()) {
                                valueStr = '?';
                            } else if (value.is_not_applicable()) {
                                valueStr = '.';
                            }
                            result += `  ${key}: ${valueStr} (${value.value_type})\n`;
                        }
                    }
                    
                    // Process loops
                    for (let j = 0; j < block.get_loop_count(); j++) {
                        const loop = block.get_loop(j);
                        result += `
<strong>Loop ${j}:</strong>
- Columns: ${loop.get_column_count()} (${loop.get_tags().join(', ')})
- Rows: ${loop.get_row_count()}

<strong>Sample Data:</strong>
`;
                        
                        // Show first few rows
                        const maxRows = Math.min(3, loop.get_row_count());
                        for (let row = 0; row < maxRows; row++) {
                            result += `  Row ${row}: `;
                            const rowData = [];
                            for (let col = 0; col < loop.get_column_count(); col++) {
                                const value = loop.get_value(row, col);
                                if (value) {
                                    if (value.is_text()) {
                                        rowData.push(`"${value.text_value}"`);
                                    } else if (value.is_numeric()) {
                                        rowData.push(value.numeric_value.toString());
                                    } else {
                                        rowData.push(value.value_type);
                                    }
                                }
                            }
                            result += rowData.join(', ') + '\n';
                        }
                        
                        if (loop.get_row_count() > maxRows) {
                            result += `  ... and ${loop.get_row_count() - maxRows} more rows\n`;
                        }
                    }
                    
                    // Process save frames
                    for (let k = 0; k < block.get_frame_count(); k++) {
                        const frame = block.get_frame(k);
                        result += `
<strong>Save Frame "${frame.name}":</strong>
- Items: ${frame.get_item_keys().length}
- Loops: ${frame.get_loop_count()}
`;
                        
                        const frameKeys = frame.get_item_keys();
                        for (const key of frameKeys) {
                            const value = frame.get_item(key);
                            if (value) {
                                let valueStr = '';
                                if (value.is_text()) {
                                    valueStr = `"${value.text_value}"`;
                                } else if (value.is_numeric()) {
                                    valueStr = value.numeric_value.toString();
                                }
                                result += `  ${key}: ${valueStr}\n`;
                            }
                        }
                    }
                }
                
                output.innerHTML = result;
                
            } catch (error) {
                output.innerHTML = `<span class="error">❌ Parsing failed:</span>

${error.toString()}

<strong>Common issues:</strong>
- Check that data block names start with 'data_'
- Ensure loops have matching numbers of tags and values
- Verify text fields are properly delimited with semicolons
- Make sure quotes are properly closed`;
            }
        }
        
        window.clearOutput = function() {
            document.getElementById('output').innerHTML = 'Output cleared. Enter CIF content and click "Parse CIF".';
        }
        
        // Initialize on page load
        initWasm();
    </script>
</body>
</html>