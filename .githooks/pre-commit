#!/bin/sh
# Pre-commit hook for cif-parser project
# Runs formatting and linting checks for all languages

set -e

echo "Running pre-commit checks..."

# Rust Checks
echo "ğŸ¦€ Running Rust checks..."

echo "  ğŸ” Checking code formatting with cargo fmt..."
cargo fmt -- --check
if [ $? -ne 0 ]; then
    echo "  âŒ Code formatting check failed. Run 'cargo fmt' to fix."
    exit 1
fi

echo "  ğŸ” Running clippy linter..."
cargo clippy --all-features -- -D warnings
if [ $? -ne 0 ]; then
    echo "  âŒ Clippy found issues. Please fix them before committing."
    exit 1
fi

# Python Checks
if [ -d "python" ]; then
    echo "ğŸ Running Python checks..."

    echo "  ğŸ” Checking formatting with black..."
    (cd python && uv run black --check .)
    if [ $? -ne 0 ]; then
        echo "  âŒ Python formatting check failed. Run 'cd python && uv run black .' to fix."
        exit 1
    fi

    echo "  ğŸ” Linting with ruff..."
    (cd python && uv run ruff check .)
    if [ $? -ne 0 ]; then
        echo "  âŒ Ruff found issues. Run 'cd python && uv run ruff check --fix .' to fix."
        exit 1
    fi

    echo "  ğŸ” Type checking with mypy..."
    (cd python && uv run mypy .)
    if [ $? -ne 0 ]; then
        echo "  âŒ Mypy found type errors. Please fix them before committing."
        exit 1
    fi
fi

# JavaScript Checks
if [ -d "javascript" ] && [ -f "javascript/package.json" ]; then
    echo "ğŸ“œ Running JavaScript checks..."

    # Check if node_modules exists, if not warn user
    if [ ! -d "javascript/node_modules" ]; then
        echo "  âš ï¸  Warning: node_modules not found. Run 'cd javascript && npm install' first."
        echo "  Skipping JavaScript checks..."
    else
        echo "  ğŸ” Checking formatting and linting with Biome..."
        (cd javascript && npx @biomejs/biome ci .)
        if [ $? -ne 0 ]; then
            echo "  âŒ Biome found issues. Run 'cd javascript && npx @biomejs/biome check --write .' to fix."
            exit 1
        fi
    fi
fi

echo "âœ… All formatting and linting checks passed!"
echo ""
echo "ğŸ’¡ Tip: The build and tests will run in CI. To run them locally:"
echo "   cargo build --all-features"
echo "   cargo test --all-features"
